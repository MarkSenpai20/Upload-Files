<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vantal P2P | Corrupt-Free</title>
    
    <!-- Tailwind & Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    
    <!-- Zip Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .progress-fill { transition: width 0.1s linear; }
        
        /* Mobile Tweaks */
        @media (max-width: 640px) {
            .mobile-stack { flex-direction: column; align-items: stretch; }
            .mobile-full { width: 100%; }
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 font-sans h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-slate-800 border-b border-slate-700 p-3 md:p-4 flex justify-between items-center z-50 shadow-lg relative shrink-0">
        <div class="flex items-center gap-3">
            <div class="relative">
                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white text-lg shadow-lg shadow-blue-900/40">
                    <i class="fa-solid fa-bolt"></i>
                </div>
                <!-- Status Dot -->
                <div id="status-dot" class="absolute -bottom-1 -right-1 w-3.5 h-3.5 bg-red-500 rounded-full border-2 border-slate-800 transition-colors duration-300"></div>
            </div>
            <div>
                <h1 class="font-bold text-white text-lg leading-tight tracking-tight">Vantal<span class="text-blue-500">Studios</span></h1>
                <p id="connection-status" class="text-[10px] text-slate-400 font-mono">OFFLINE</p>
            </div>
        </div>
        <div id="shop-controls" class="hidden">
            <button onclick="downloadAll()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-2 rounded-lg text-xs font-bold shadow-lg shadow-emerald-900/20 flex items-center gap-2 transition-all active:scale-95 whitespace-nowrap">
                <i class="fa-solid fa-file-zipper"></i> <span class="hidden sm:inline">Download All</span><span class="sm:hidden">Zip</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden relative">
        
        <!-- SCREEN 1: MODE SELECTION -->
        <div id="screen-setup" class="w-full flex-1 flex flex-col items-center justify-center p-6 absolute inset-0 z-40 bg-slate-900 transition-transform duration-300 overflow-y-auto">
            <div class="max-w-md w-full grid grid-cols-1 gap-4">
                <h2 class="text-2xl font-bold text-center text-white mb-4">Select Mode</h2>
                
                <button onclick="setupMode('sender')" class="group relative bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-blue-500 p-6 rounded-2xl text-left transition-all shadow-xl active:scale-95">
                    <div class="absolute right-6 top-6 text-3xl text-slate-600 group-hover:text-blue-500 transition-colors">
                        <i class="fa-solid fa-paper-plane"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-1">Customer</h3>
                    <p class="text-slate-400 text-sm">I want to send files</p>
                </button>

                <button onclick="setupMode('receiver')" class="group relative bg-slate-800 hover:bg-slate-700 border border-slate-700 hover:border-green-500 p-6 rounded-2xl text-left transition-all shadow-xl active:scale-95">
                    <div class="absolute right-6 top-6 text-3xl text-slate-600 group-hover:text-green-500 transition-colors">
                        <i class="fa-solid fa-shop"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-1">Shop (Receiver)</h3>
                    <p class="text-slate-400 text-sm">I want to receive files</p>
                </button>
            </div>
        </div>

        <!-- SCREEN 2: SENDER -->
        <div id="screen-sender" class="w-full flex-1 flex flex-col items-center justify-center p-4 md:p-6 absolute inset-0 z-30 bg-slate-900 translate-x-full transition-transform duration-300 overflow-y-auto">
            <div class="max-w-md w-full bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-2xl">
                
                <!-- Connect -->
                <div id="sender-step-1">
                    <h3 class="font-bold text-white mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-link text-blue-500"></i> Connect to Shop
                    </h3>
                    <div class="flex gap-2">
                        <input type="text" id="target-id" placeholder="Shop ID (e.g. vantal)" class="flex-1 bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white focus:border-blue-500 outline-none font-mono">
                        <button onclick="connectToShop()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 rounded-lg font-bold transition-colors active:scale-95">Join</button>
                    </div>
                </div>

                <!-- Upload -->
                <div id="sender-step-2" class="hidden mt-6 fade-in">
                    <div class="border-2 border-dashed border-slate-600 hover:border-blue-500 bg-slate-900/50 rounded-xl h-48 flex flex-col items-center justify-center cursor-pointer transition-colors group relative active:bg-slate-800" onclick="document.getElementById('file-input').click()">
                        <input type="file" id="file-input" class="hidden" multiple onchange="startUploadQueue(this.files)">
                        <div id="drop-icon">
                            <i class="fa-solid fa-cloud-arrow-up text-4xl text-slate-500 group-hover:text-blue-500 mb-3 transition-colors"></i>
                            <p class="text-slate-300 font-bold group-hover:text-white">Tap to Upload</p>
                        </div>
                        <div id="drop-spinner" class="hidden text-center">
                            <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-500 mb-3"></i>
                            <p class="text-blue-400 font-bold">Sending...</p>
                        </div>
                    </div>
                    
                    <!-- Sender Progress -->
                    <div id="sender-progress-container" class="mt-4 hidden">
                         <div class="flex justify-between text-xs text-slate-400 mb-1">
                             <span id="sender-filename" class="truncate max-w-[200px]">filename.jpg</span>
                             <span id="sender-percent">0%</span>
                         </div>
                         <div class="h-2 w-full bg-slate-700 rounded-full overflow-hidden">
                             <div id="sender-bar" class="h-full bg-blue-500 w-0 progress-fill"></div>
                         </div>
                    </div>
                </div>
                
                <button onclick="location.reload()" class="mt-4 w-full text-slate-500 text-xs hover:text-white">Cancel / Restart</button>

            </div>
        </div>

        <!-- SCREEN 3: RECEIVER -->
        <div id="screen-receiver" class="w-full flex-1 flex flex-col absolute inset-0 z-30 bg-slate-900 translate-x-full transition-transform duration-300">
            <!-- Sidebar / ID Display -->
            <div class="bg-slate-800 border-b border-slate-700 p-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 shrink-0">
                <div class="flex flex-col md:flex-row md:items-center gap-2 md:gap-3 w-full">
                    <span class="text-slate-400 text-sm whitespace-nowrap">Shop ID:</span>
                    <div class="bg-slate-900 border border-slate-600 px-4 py-2 rounded-lg font-mono text-green-400 font-bold text-lg select-all w-full md:w-auto text-center md:text-left break-all" id="my-peer-id">Generating...</div>
                </div>
                <div class="text-xs text-slate-500 flex items-center gap-2 whitespace-nowrap">
                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> 
                    Waiting...
                </div>
            </div>

            <!-- File List -->
            <div id="file-list" class="flex-1 overflow-y-auto p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 content-start pb-20"></div>
        </div>
    </div>
    
    <!-- SYSTEM LOG (Debug Panel) -->
    <div id="system-log" class="fixed bottom-0 left-0 w-full h-32 bg-slate-950 border-t border-slate-800 p-2 font-mono text-[10px] text-green-500 overflow-y-auto z-50 opacity-90 hidden"></div>
    <button onclick="document.getElementById('system-log').classList.toggle('hidden')" class="fixed bottom-2 right-2 z-50 bg-slate-800 text-slate-400 p-2 rounded-lg text-xs hover:text-white"><i class="fa-solid fa-terminal"></i></button>

    <!-- LOGIC -->
    <script>
        // --- CONFIGURATION ---
        const CHUNK_SIZE = 16 * 1024; // 16KB Safe Chunk Size
        
        let peer = null;
        let conn = null;
        let receivedFiles = [];
        let incomingTransfers = {};

        // Logging
        function log(msg) {
            const el = document.getElementById('system-log');
            const time = new Date().toLocaleTimeString();
            el.innerHTML += `<div class="mb-0.5 border-b border-slate-800/50 pb-0.5"><span class="text-slate-500">[${time}]</span> ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
            console.log(msg);
        }

        function setupMode(mode) {
            document.getElementById('screen-setup').classList.add('-translate-y-full');
            if (mode === 'sender') document.getElementById('screen-sender').classList.remove('translate-x-full');
            else {
                document.getElementById('screen-receiver').classList.remove('translate-x-full');
                document.getElementById('shop-controls').classList.remove('hidden');
                initShopMode();
            }
        }

        // ===============================================
        // SHOP (RECEIVER)
        // ===============================================
        function initShopMode() {
            const preferredId = prompt("Enter Shop ID (e.g. vantal):", "vantal");
            if(!preferredId) return location.reload();

            // Force Reliable Mode
            peer = new Peer(preferredId, {
                debug: 2,
                config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] } 
            });

            peer.on('open', (id) => {
                document.getElementById('my-peer-id').innerText = id;
                setStatus('ONLINE', 'green');
                log("Shop Initialized.");
            });

            peer.on('connection', (c) => {
                conn = c;
                setupReceiverConnection(conn);
            });
            
            peer.on('error', (err) => {
                alert("Error: " + err.type);
                log("Peer Error: " + err);
            });
        }

        function setupReceiverConnection(connection) {
            connection.on('open', () => {
                setStatus('CONNECTED', 'blue');
                log("Customer connected via DataChannel");
            });

            connection.on('data', (data) => {
                if (data.type === 'start') {
                    startTransfer(data);
                } else if (data.type === 'chunk') {
                    processChunk(data);
                } else if (data.type === 'end') {
                    finishTransfer(data);
                }
            });

            connection.on('close', () => {
                setStatus('ONLINE', 'green');
                log("Customer disconnected");
            });
        }

        function startTransfer(data) {
            log(`Incoming: ${data.name} (${data.size} bytes)`);
            
            incomingTransfers[data.id] = {
                name: data.name,
                size: data.size,
                mime: data.mime || 'application/octet-stream',
                chunks: new Array(data.totalChunks), // PRE-ALLOCATE SLOTS
                receivedChunks: 0,
                totalChunks: data.totalChunks,
                lastPercent: 0
            };

            // Create UI Card
            const sizeMB = (data.size / (1024*1024)).toFixed(2);
            const div = document.createElement('div');
            div.id = `card-${data.id}`;
            div.className = "bg-slate-800 border border-slate-700 p-4 rounded-xl fade-in relative overflow-hidden flex flex-col justify-center min-h-[100px]";
            div.innerHTML = `
                <div class="flex items-center gap-3 relative z-10 w-full pr-10">
                    <div class="w-12 h-12 bg-slate-700 rounded-lg flex items-center justify-center text-slate-500 shrink-0 icon-box text-xl">
                        <i class="fa-solid fa-spinner fa-spin"></i>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <h4 class="font-bold text-white text-sm truncate w-full" title="${data.name}">${data.name}</h4>
                        <div class="flex justify-between text-[10px] text-slate-400 mt-1">
                            <span>${sizeMB} MB</span>
                            <span class="status-text font-mono">0%</span>
                        </div>
                    </div>
                </div>
                <div class="absolute bottom-0 left-0 h-1 bg-blue-500 w-0 progress-bar transition-all duration-100"></div>
                
                <!-- Download Button (Hidden Initially) -->
                <button id="btn-${data.id}" class="absolute right-3 top-1/2 -translate-y-1/2 bg-slate-700 text-slate-500 hover:bg-slate-600 hover:text-white p-3 rounded-full transition-all duration-300 hidden active:scale-90 shadow-lg z-20">
                    <i class="fa-solid fa-download"></i>
                </button>
            `;
            document.getElementById('file-list').prepend(div);
        }

        function processChunk(data) {
            const transfer = incomingTransfers[data.id];
            if(!transfer) return;

            // CRITICAL FIX: Place chunk in correct index
            transfer.chunks[data.index] = data.data; 
            transfer.receivedChunks++;

            const percent = Math.floor((transfer.receivedChunks / transfer.totalChunks) * 100);
            
            if (percent > transfer.lastPercent + 2 || percent === 100) {
                transfer.lastPercent = percent;
                const card = document.getElementById(`card-${data.id}`);
                if(card) {
                    card.querySelector('.progress-bar').style.width = `${percent}%`;
                    card.querySelector('.status-text').innerText = `${percent}%`;
                }
            }
        }

        function finishTransfer(data) {
            const transfer = incomingTransfers[data.id];
            
            // Integrity Check
            if (transfer.receivedChunks !== transfer.totalChunks) {
                log(`Error: Missing chunks for ${transfer.name}. Got ${transfer.receivedChunks}/${transfer.totalChunks}`);
                alert("File transfer incomplete/corrupted. Please retry.");
                return;
            }

            log(`Finished & Verified: ${transfer.name}`);

            // Reassemble Blob strictly in order
            const blob = new Blob(transfer.chunks, { type: transfer.mime });
            receivedFiles.push({ name: transfer.name, blob: blob });
            
            // Finalize Card UI
            const card = document.getElementById(`card-${data.id}`);
            if(card) {
                card.classList.add('border-green-500/50');
                card.querySelector('.progress-bar').classList.add('bg-green-500');
                card.querySelector('.progress-bar').style.width = '100%';
                
                card.querySelector('.status-text').innerText = "Complete";
                card.querySelector('.status-text').classList.add('text-green-400');
                
                const iconBox = card.querySelector('.icon-box');
                iconBox.innerHTML = '<i class="fa-solid fa-check text-green-500"></i>';
                iconBox.classList.add('bg-green-500/10');
                
                const btn = document.getElementById(`btn-${data.id}`);
                btn.classList.remove('hidden', 'bg-slate-700', 'text-slate-500');
                btn.classList.add('bg-green-500', 'text-white', 'hover:bg-green-400', 'pulse-once');
                
                btn.onclick = (e) => {
                    e.stopPropagation();
                    saveAs(blob, transfer.name);
                };
            }
            
            // Free memory but keep blob ref
            // transfer.chunks = null; 
            delete incomingTransfers[data.id];
        }

        // ===============================================
        // CUSTOMER (SENDER)
        // ===============================================
        function connectToShop() {
            const targetId = document.getElementById('target-id').value.trim();
            if(!targetId) return alert("Enter ID");

            log("Connecting to: " + targetId);
            peer = new Peer({ debug: 2 });

            peer.on('open', () => {
                conn = peer.connect(targetId, { reliable: true });
                setupSenderConnection(conn);
            });

            peer.on('error', err => {
                alert("Connection failed: " + err.type);
                log("Error: " + err);
            });
        }

        function setupSenderConnection(connection) {
            connection.on('open', () => {
                document.getElementById('sender-step-1').classList.add('hidden');
                document.getElementById('sender-step-2').classList.remove('hidden');
                setStatus('CONNECTED', 'blue');
                log("Connected to Shop!");
            });

            connection.on('close', () => {
                alert("Shop disconnected");
                location.reload();
            });

            connection.on('error', err => log("Conn Error: " + err));
        }

        async function startUploadQueue(files) {
            const input = document.getElementById('file-input');
            const dropIcon = document.getElementById('drop-icon');
            const dropSpinner = document.getElementById('drop-spinner');
            
            dropIcon.classList.add('hidden');
            dropSpinner.classList.remove('hidden');
            input.disabled = true;

            for (let file of files) {
                await sendSingleFile(file);
            }

            dropIcon.classList.remove('hidden');
            dropSpinner.classList.add('hidden');
            input.disabled = false;
            input.value = '';
            
            document.getElementById('sender-filename').innerText = "All Files Sent!";
            document.getElementById('sender-percent').innerText = "100%";
            document.getElementById('sender-bar').style.width = "100%";
        }

        function sendSingleFile(file) {
            return new Promise((resolve) => {
                const transferId = Math.random().toString(36).substr(2, 9);
                log(`Preparing ${file.name}...`);

                // UI
                document.getElementById('sender-progress-container').classList.remove('hidden');
                document.getElementById('sender-filename').innerText = file.name;
                const progressBar = document.getElementById('sender-bar');
                const percentText = document.getElementById('sender-percent');

                const totalChunks = Math.ceil(file.size / CHUNK_SIZE);

                // 1. Send Start
                conn.send({ 
                    type: 'start', 
                    id: transferId, 
                    name: file.name, 
                    size: file.size,
                    mime: file.type,
                    totalChunks: totalChunks
                });

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const buffer = e.target.result;
                    let chunkIndex = 0;
                    let offset = 0;

                    // 2. Buffered Send Loop
                    while (offset < file.size) {
                        // Backpressure Check
                        if (conn.dataChannel.bufferedAmount > 16 * 1024 * 1024) { 
                            await new Promise(r => setTimeout(r, 50));
                            continue;
                        }

                        const chunk = buffer.slice(offset, offset + CHUNK_SIZE);
                        offset += CHUNK_SIZE;

                        conn.send({
                            type: 'chunk',
                            id: transferId,
                            index: chunkIndex, // CRITICAL: Send Index
                            data: chunk
                        });
                        chunkIndex++;

                        // UI Update
                        const percent = Math.min(100, Math.round((offset / file.size) * 100));
                        progressBar.style.width = `${percent}%`;
                        percentText.innerText = `${percent}%`;

                        // Breath
                        if (offset % (CHUNK_SIZE * 5) === 0) await new Promise(r => setTimeout(r, 1));
                    }

                    // 3. Send End
                    conn.send({ type: 'end', id: transferId });
                    log(`Sent ${file.name}`);
                    resolve();
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // ===============================================
        // UTILS
        // ===============================================
        function setStatus(msg, color) {
            const el = document.getElementById('connection-status');
            const dot = document.getElementById('status-dot');
            el.innerText = msg;
            
            const colorClass = color === 'green' ? 'bg-green-500' : (color === 'blue' ? 'bg-blue-500' : 'bg-red-500');
            dot.className = `absolute -bottom-1 -right-1 w-3.5 h-3.5 rounded-full border-2 border-slate-900 ${colorClass} ${color === 'blue' ? 'animate-pulse' : ''}`;
        }

        function downloadAll() {
            if(receivedFiles.length === 0) return alert("No files received.");
            const zip = new JSZip();
            receivedFiles.forEach(f => zip.file(f.name, f.blob));
            zip.generateAsync({type:"blob"}).then(c => saveAs(c, "vantal_files.zip"));
        }
    </script>
</body>
</html>


